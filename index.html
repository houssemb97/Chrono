<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ChronoClasse — Saisie + Clic + Autocomplétion + Mode du jour</title>
<style>
  :root { --gap: 10px; --radius: 10px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background:#0b0f14; color:#e8eef6; }
  h1 { margin:0 0 8px; font-size:24px; }
  .card { background:#121826; border:1px solid #223; border-radius:var(--radius); padding:16px; margin-bottom:16px; }
  label, select, button, input { font-size:16px; }
  select, input[type="text"] { background:#0f1420; color:#e8eef6; border:1px solid #2a3346; border-radius:8px; padding:10px 12px; }
  button { background:#2a6bf2; color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; }
  button.secondary { background:#23314a; }
  button.warn { background:#6f4f10; }
  button:disabled { opacity:.5; cursor:not-allowed; }
  .chips { display:flex; flex-wrap:wrap; gap:var(--gap); margin-top:10px; }
  .chip { background:#0f1420; border:1px solid #2a3346; padding:8px 10px; border-radius:999px; cursor:pointer; user-select:none; transition:transform .06s ease; }
  .chip.disabled { opacity:.45; text-decoration:line-through; cursor:default; }
  .row { display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; }
  .muted { color:#9fb0d0; font-size:14px; }
  .ok { color:#31d0aa; }
  .ko { color:#ff6b6b; }
  .notice { margin-top:8px; min-height:1.2em; }
  .list { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  .pill { background:#172033; border:1px solid #2a3346; padding:6px 10px; border-radius:999px; }
  .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; background:#0f1420; border:1px solid #2a3346; padding:2px 6px; border-radius:6px; }
  .modepill { background:#14351f; border:1px solid #1e6b3e; color:#bff3cf; }
  /* Autocomplete */
  .ac-wrap { position:relative; flex:1; min-width:260px; }
  .ac-list { position:absolute; top:100%; left:0; right:0; background:#0f1420; border:1px solid #2a3346; border-top:none; border-radius:0 0 8px 8px; max-height:220px; overflow:auto; z-index:10; display:none; }
  .ac-item { padding:8px 10px; cursor:pointer; }
  .ac-item.kbdhint { font-size:13px; color:#9fb0d0; border-top:1px dashed #223; }
  .ac-item.active, .ac-item:hover { background:#172033; }
  .shake { animation: shake 0.35s ease; }
  @keyframes shake {
    10%, 90% { transform: translateX(-1px); }
    20%, 80% { transform: translateX(2px); }
    30%, 50%, 70% { transform: translateX(-4px); }
    40%, 60% { transform: translateX(4px); }
  }
  /* Flash sur chips */
  .flash-ok { animation: flashok .6s ease; }
  .flash-ko { animation: flashko .6s ease; }
  @keyframes flashok {
    0% { background:#0f1420; }
    20% { background:#0f2a20; transform:scale(1.05); }
    100% { background:#0f1420; transform:scale(1); }
  }
  @keyframes flashko {
    0% { background:#0f1420; }
    20% { background:#2a1414; transform:scale(0.98); }
    100% { background:#0f1420; transform:scale(1); }
  }
</style>
</head>
<body>
  <h1>ChronoClasse</h1>
  <p class="muted">Donne les 5 propositions <b>dans l’ordre chronologique</b>, un <b>mot à la fois</b>.  
  Tu peux <b>taper</b> (autocomplétion ≥ 3 lettres, ↓/↑ + Entrée) <i>ou</i> <b>cliquer</b> un mot.</p>

  <div class="card">
    <div class="row">
      <label for="cat">Catégorie :</label>
      <select id="cat"></select>
      <button id="new">Nouvelle manche</button>
      <button id="toggleDaily" class="secondary">Mode du jour : <span id="dailyState">OFF</span></button>
      <span id="meta" class="muted"></span>
      <span id="dailyPill" class="pill modepill" style="display:none;">Mode du jour actif</span>
    </div>
    <div style="margin-top:10px;">
      <div class="muted">Propositions (5 éléments) — clique pour proposer :</div>
      <div id="chips" class="chips"></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="ac-wrap">
        <input id="guess" type="text" placeholder="Tape un mot… (≥3 lettres pour proposer)" autocomplete="off" spellcheck="false">
        <div id="ac" class="ac-list"></div>
      </div>
      <button id="validate">Valider ce mot</button>
      <button id="undo">Annuler dernier</button>
      <button id="reset" class="warn">Réinitialiser</button>
    </div>
    <div id="notice" class="notice"></div>
    <div>
      <div class="muted">Votre ordre saisi :</div>
      <div id="entered" class="list"></div>
    </div>
    <div id="result" class="notice"></div>
  </div>

  <div class="card">
    <details>
      <summary>Astuce clavier</summary>
      <p class="muted">
        Tape ≥ 3 lettres → <span class="kbd">↓</span>/<span class="kbd">↑</span> pour naviguer les suggestions → <span class="kbd">Entrée</span> pour insérer.  
        Si aucune suggestion n’est active, <span class="kbd">Entrée</span> valide le mot saisi.  
        Tu peux aussi <b>cliquer</b> un mot proposé pour le valider.
      </p>
    </details>
  </div>

<script>
(() => {
  // ----------------------- Données de démo -----------------------
  const CATEGORIES = {
    "Objets": [
      { label:"Boussole", year:1100 },
      { label:"Imprimerie", year:1440 },
      { label:"Machine à vapeur", year:1712 },
      { label:"Appareil photo", year:1826 },
      { label:"Ampoule électrique", year:1879 },
      { label:"Avion", year:1903 },
      { label:"Transistor", year:1947 },
      { label:"Microprocesseur", year:1971 },
      { label:"Lecteur CD", year:1982 },
      { label:"Smartphone", year:2007 }
    ],
    "Musique": [
      { label:"Vinyle LP", year:1948 },
      { label:"Cassette audio", year:1963 },
      { label:"Synthétiseur Moog", year:1964 },
      { label:"Walkman", year:1979 },
      { label:"CD audio", year:1982 },
      { label:"MP3 (format)", year:1993 },
      { label:"iPod", year:2001 },
      { label:"Spotify", year:2008 }
    ],
    "Cinéma": [
      { label:"Cinématographe", year:1895 },
      { label:"Film parlant", year:1927 },
      { label:"Technicolor", year:1932 },
      { label:"IMAX", year:1970 },
      { label:"CGI moderne", year:1973 },
      { label:"3D polarisée", year:1986 },
      { label:"DVD vidéo", year:1996 },
      { label:"Streaming grand public", year:2007 }
    ],
    "Événements historiques": [
      { label:"Prise de la Bastille", year:1789 },
      { label:"Télégraphe de Morse (démo)", year:1838 },
      { label:"Première Guerre mondiale", year:1914 },
      { label:"Chute du mur de Berlin", year:1989 },
      { label:"Traité de Maastricht", year:1992 },
      { label:"Internet grand public", year:1993 },
      { label:"Euro fiduciaire", year:2002 },
      { label:"Premier vol habité privé", year:2020 }
    ]
  };

  // ----------------------- Utils -----------------------
  const $ = sel => document.querySelector(sel);
  const norm = s => s.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();

  // Seeded RNG for daily mode (Mulberry32)
  function mulberry32(a){ return function(){ var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }
  function hashStr(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
  function choiceNSeeded(arr, n, seed){ const rng = mulberry32(seed); const pool=[...arr]; const out=[]; while(out.length<n && pool.length){ const i=Math.floor(rng()*pool.length); out.push(...pool.splice(i,1)); } return out; }

  // ----------------------- Éléments -----------------------
  const elCat = $('#cat'), elNew = $('#new'), elChips = $('#chips');
  const elGuess = $('#guess'), elAC = $('#ac'), elValidate = $('#validate');
  const elUndo = $('#undo'), elReset = $('#reset'), elNotice = $('#notice');
  const elEntered = $('#entered'), elResult = $('#result'), elMeta = $('#meta');
  const elToggleDaily = $('#toggleDaily'), elDailyState = $('#dailyState'), elDailyPill = $('#dailyPill');

  // ----------------------- État -----------------------
  let currentPool = [];       // 5 objets {label,year}
  let expectedOrder = [];     // labels triés par year asc
  let entered = [];           // labels saisis validés
  let acIndex = -1;           // index suggestion active
  let dailyMode = JSON.parse(localStorage.getItem('chronoclasse-daily')||'false');

  // ----------------------- Rendu -----------------------
  function renderChips() {
    elChips.innerHTML = '';
    currentPool.forEach(o => {
      const used = entered.includes(o.label);
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip' + (used ? ' disabled' : '');
      b.textContent = o.label;
      b.disabled = used;
      b.addEventListener('click', () => {
        if (b.disabled) return;
        attemptValidate(o.label, b); // clic = validation
      });
      elChips.appendChild(b);
    });
  }
  function renderEntered() {
    elEntered.innerHTML = '';
    entered.forEach((lab,i) => {
      const d = document.createElement('span');
      d.className = 'pill';
      d.textContent = `${i+1}. ${lab}`;
      elEntered.appendChild(d);
    });
  }
  function setNotice(msg, ok=false) {
    elNotice.textContent = msg || '';
    elNotice.classList.remove('ok','ko');
    if (!msg) return;
    elNotice.classList.add(ok ? 'ok' : 'ko');
    if (!ok) {
      elGuess.classList.remove('shake'); void elGuess.offsetWidth; elGuess.classList.add('shake');
    }
  }
  function clearResult() { elResult.textContent = ''; }

  // ----------------------- Autocomplete -----------------------
  function closeAC(){ elAC.style.display='none'; elAC.innerHTML=''; acIndex=-1; }
  function openAC(items){
    elAC.innerHTML='';
    items.forEach((lab, i) => {
      const div = document.createElement('div');
      div.className = 'ac-item';
      div.textContent = lab;
      div.addEventListener('mouseenter', () => setActive(i));
      div.addEventListener('mousedown', (e) => { e.preventDefault(); pickAC(i, true); });
      elAC.appendChild(div);
    });
    const hint = document.createElement('div');
    hint.className = 'ac-item kbdhint';
    hint.innerHTML = 'Astuce : <span class="kbd">↓</span>/<span class="kbd">↑</span> pour naviguer, <span class="kbd">Entrée</span> pour insérer';
    elAC.appendChild(hint);
    elAC.style.display = items.length ? 'block' : 'none';
    acIndex = items.length ? 0 : -1;
    highlightAC();
  }
  function highlightAC(){
    [...elAC.querySelectorAll('.ac-item')].forEach((n,i) => {
      if (n.classList.contains('kbdhint')) return;
      n.classList.toggle('active', i === acIndex);
    });
  }
  function setActive(i){
    const items = elAC.querySelectorAll('.ac-item:not(.kbdhint)');
    if (!items.length) return;
    acIndex = Math.max(0, Math.min(i, items.length-1));
    highlightAC();
  }
  function moveAC(delta){
    const items = elAC.querySelectorAll('.ac-item:not(.kbdhint)');
    if (!items.length) return;
    acIndex = (acIndex + delta + items.length) % items.length;
    highlightAC();
  }
  function pickAC(i, andValidate=false){
    const items = [...elAC.querySelectorAll('.ac-item:not(.kbdhint)')];
    if (!items.length) return;
    const lab = items[i].textContent;
    elGuess.value = lab;
    closeAC();
    if (andValidate) validateCurrent();
  }
  function updateAC(){
    const q = norm(elGuess.value);
    const remaining = currentPool.map(o=>o.label).filter(l => !entered.includes(l));
    if (q.length < 3) { closeAC(); return; }
    const matches = remaining.filter(l => norm(l).startsWith(q));
    if (matches.length) openAC(matches); else closeAC();
  }

  elGuess.addEventListener('input', () => { setNotice(''); clearResult(); updateAC(); });
  elGuess.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') { e.preventDefault(); moveAC(1); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); moveAC(-1); }
    else if (e.key === 'Enter') {
      const hasOpen = elAC.style.display === 'block';
      const items = elAC.querySelectorAll('.ac-item:not(.kbdhint)');
      if (hasOpen && items.length && acIndex >= 0) {
        e.preventDefault();
        pickAC(acIndex, true);
      } else {
        e.preventDefault();
        validateCurrent();
      }
    } else if (e.key === 'Escape') {
      closeAC();
    }
  });
  document.addEventListener('click', (e) => {
    if (!elAC.contains(e.target) && e.target !== elGuess) closeAC();
  });

  // ----------------------- Logique de validation -----------------------
  function flash(el, ok) {
    if (!el) return;
    el.classList.remove('flash-ok','flash-ko'); void el.offsetWidth;
    el.classList.add(ok ? 'flash-ok' : 'flash-ko');
    setTimeout(() => el.classList.remove('flash-ok','flash-ko'), 650);
  }

  function findChipByLabel(label){
    const nodes = [...elChips.querySelectorAll('.chip')];
    return nodes.find(n => n.textContent === label);
  }

  function attemptValidate(label, chipEl){
    // 1) doit être dans les propositions restantes
    const remaining = currentPool.map(o=>o.label).filter(l => !entered.includes(l));
    if (!remaining.includes(label)) {
      setNotice('Mot invalide (non présent ou déjà utilisé).', false);
      flash(chipEl || findChipByLabel(label), false);
      // Efface la barre si ça vient de la saisie
      elGuess.value = '';
      closeAC();
      elGuess.focus();
      return false;
    }
    // 2) doit être le prochain attendu
    const want = expectedOrder[entered.length];
    if (label === want) {
      entered.push(label);
      renderEntered();
      renderChips();
      setNotice('Correct ✅', true);
      flash(chipEl || findChipByLabel(label), true);
      clearResult();
      elGuess.value = '';
      closeAC();
      if (entered.length === 5) finish();
      else { updateAC(); elGuess.focus(); }
      return true;
    } else {
      setNotice(`Faux ❌ — Ce n'est pas le mot attendu à la position ${entered.length+1}.`, false);
      flash(chipEl || findChipByLabel(label), false);
      // Efface la barre sur erreur
      elGuess.value = '';
      closeAC();
      elGuess.focus();
      return false;
    }
  }

  function validateCurrent(){
    const val = elGuess.value.trim();
    if (!val) { setNotice('Entre un mot.', false); return; }
    attemptValidate(val, null);
  }

  function finish(){
    const correct = expectedOrder.join(' → ');
    elResult.innerHTML = `<span class="ok">Bravo !</span> Ordre correct : ${correct}`;
    setNotice('');
  }

  // ----------------------- Mode du jour -----------------------
  function setDailyUI(){
    elDailyState.textContent = dailyMode ? 'ON' : 'OFF';
    elDailyPill.style.display = dailyMode ? 'inline-block' : 'none';
  }
  function getDailySeed(catName){
    const d = new Date();
    const iso = d.toISOString().slice(0,10); // YYYY-MM-DD
    return hashStr(`${iso}:${catName}`);
  }

  // ----------------------- Manche -----------------------
  function newRound() {
    entered = []; elResult.textContent = ''; setNotice('');
    const catName = elCat.value;
    const pool = CATEGORIES[catName];

    if (dailyMode) {
      const seed = getDailySeed(catName);
      currentPool = choiceNSeeded(pool, 5, seed);
    } else {
      // tirage pseudo-aléatoire classique
      const temp = [...pool];
      currentPool = [];
      while (currentPool.length < 5 && temp.length) {
        currentPool.push(...temp.splice(Math.floor(Math.random()*temp.length),1));
      }
    }

    expectedOrder = [...currentPool].sort((a,b)=>a.year-b.year).map(o=>o.label);
    renderChips();
    renderEntered();
    elMeta.textContent = `Catégorie « ${catName} » — repère: ${Math.min(...currentPool.map(o=>o.year))}–${Math.max(...currentPool.map(o=>o.year))}`;
    elGuess.value = ''; elGuess.focus();
    closeAC();
  }

  // ----------------------- Contrôles -----------------------
  const elToggleDailyHandler = () => {
    dailyMode = !dailyMode;
    localStorage.setItem('chronoclasse-daily', JSON.stringify(dailyMode));
    setDailyUI();
    newRound(); // on relance une manche avec le nouveau mode
  };

  $('#validate').addEventListener('click', validateCurrent);
  $('#undo').addEventListener('click', () => {
    if (!entered.length) return;
    const removed = entered.pop();
    setNotice('Dernier retiré.', true);
    elGuess.value = '';
    renderEntered();
    renderChips();
    closeAC();
    elGuess.focus();
  });
  $('#reset').addEventListener('click', () => {
    entered = [];
    setNotice('Réinitialisé.', true);
    elGuess.value = '';
    renderEntered();
    renderChips();
    closeAC();
    elGuess.focus();
  });
  elNew.addEventListener('click', newRound);
  elCat.addEventListener('change', newRound);
  elToggleDaily.addEventListener('click', elToggleDailyHandler);

  // ----------------------- Init -----------------------
  function populateCats(){
    elCat.innerHTML='';
    Object.keys(CATEGORIES).forEach(k => {
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = k;
      elCat.appendChild(opt);
    });
  }
  populateCats();
  setDailyUI();
  newRound();
})();
</script>
</body>
</html>
